<!DOCTYPE html>
<!-- Author: Alexander Ingham -->
<html lang = "en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link href='https://fonts.googleapis.com/css?family=Press+Start+2P' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="css/pixi.css">
        <script src="js/pixi.min.js"></script>
        <title>Alex Ingham</title>

        <script>
            let app;
            let player;
            let gameStarted = false;
            let startTime;
            let score;
            let level = 1;
            let keys = {};
            let lasers = [];
            let asteroids = [];
            let laserSpeed = 5;
            let asteroidSpeed = 4;
            let scoreText;
            let spawnTimer = 0;
            let spawnInterval = 50;

            const scoreStyle = new PIXI.TextStyle({
                fontFamily: 'Press Start 2P',
                fontStyle: 'normal',
                display: 'inline-block',
                fontSize: '30px',
                fill: '#8BE9FD',
            });

            const gameOverStyle = new PIXI.TextStyle({
                fontFamily: 'Press Start 2P',
                fontStyle: 'bold',
                display: 'inline-block',
                fontSize: '50px',
                fill: '#8BE9FD',
            });

            const startGameStyle = new PIXI.TextStyle({
                fontFamily: 'Press Start 2P',
                fontStyle: 'normal',
                display: 'inline-block',
                fontSize: '20px',
                fill: '#8BE9FD',
            });


            window.onload = function(){
            }

            function newGame() {
                app = new PIXI.Application(
                    {
                        resizeTo: window,
                        backgroundColor: 0x282A36
                    }
                );

                document.querySelector("#gameDiv").appendChild(app.view);

                //Enable clicking to fire laser
                app.stage.interactive = true;
                document.querySelector("#gameDiv").addEventListener("pointerdown", fireLaser);
                
                //Preload Assets:
                app.loader.baseUrl = "gameImages";
                app.loader
                    .add("player", "ufo.png")
                    .add("laser", "laser.png")
                    .add("asteroid", "asteroid1.png")
                    .add("wasd", "WASD.png");
                
                app.loader.onProgress.add(showProgress);
                app.loader.onComplete.add(doneLoading);
                app.loader.onError.add(reportError);
                app.loader.load();

                //Mouse Interactions:
                // app.stage.interactive = true;
                // app.stage.on("pointermove", movePlayer)

                //Keyboard Interactions:
                window.addEventListener("keydown", keysDown);
                window.addEventListener("keyup", keysUp);
                
                score = 0;
                scoreText = new PIXI.Text('Score: 0', scoreStyle);
                app.stage.addChild(scoreText)

            }

            function startGame() {
                app.stage.removeChild(wasd);
                app.stage.removeChild(startText);
                app.ticker.add(gameLoop);
            }

            function keysDown(e) {
                keys[e.keyCode] = true;
                if (e.keyCode == "32") {
                    if(!gameStarted){
                        gameStarted = true;
                        startGame();
                    }
                    //[SPACE]
                    fireLaser();
                }
            }

            function keysUp(e) {
                keys[e.keyCode] = false;
            }

            function gameLoop(delta) {

                //Handle movement:
                if (keys["87"]) {
                    //W
                    if(player.y <= 25){
                        player.y = 25;
                    } else {
                        player.y -= player.speed;
                    }
                }
                if (keys["65"]) {
                    //A
                    if(player.x <= 25){
                        player.x = 25;
                    } else {
                        player.x -= player.speed;
                    }
                }
                if (keys["83"]) {
                    //S
                    if(player.y >= (app.renderer.height - 25)){
                        player.y = (app.renderer.height - 25);
                    } else {
                        player.y += player.speed;
                    }
                }
                if (keys["68"]) {
                    //D
                    if(player.x >= (app.renderer.width - 28)){
                        player.x = (app.renderer.width - 28);
                    } else {
                        player.x += player.speed;
                    }
                }

                //Spawn an asteroid every interval
                spawnTimer += 1;
                if(spawnTimer % spawnInterval == 0) {
                    spawnAsteroid();
                }
                
                //Handle Laser Movement
                updateLasers(delta);

                //Handle Asteroid Movement
                updateAsteroids(delta);


                if(score > 100 && level == 1) {
                    increaseDifficulty()
                } else if(score > 200 && level == 2) {
                    increaseDifficulty()
                }
            }

            function increaseDifficulty(){
                level ++;
                player.speed++;
                laserSpeed++;
                asteroidSpeed++;
                spawnInterval--;
            }

            function rectsIntersect(a, b) {
                let aBox = a.getBounds();
                let bBox = b.getBounds();
                
                return aBox.x + aBox.width > bBox.x &&
                       aBox.x < bBox.x + bBox.width &&
                       aBox.y + aBox.height > bBox.y &&
                       aBox.y < bBox.y + bBox.height;
            }

            function fireLaser() {
                let laser = createLaser();
                lasers.push(laser);
            }

            function spawnAsteroid() {
                let asteroid = createAsteroid();
                asteroids.push(asteroid);
            }

            function createLaser() {
                let laser = new PIXI.Sprite.from(app.loader.resources.laser.texture);
                laser.anchor.set(0.5);
                laser.x = player.x;
                laser.y = player.y;
                laser.speed = laserSpeed;
                app.stage.addChild(laser);

                return laser;
            }

            function createAsteroid() {
                let asteroid = PIXI.Sprite.from(app.loader.resources.asteroid.texture);
                asteroid.anchor.set(0.5);
                asteroid.x = app.view.width;
                asteroid.y = getRndInteger(0, app.view.height);
                dims = getRndInteger(40, 90);
                asteroid.width = dims
                asteroid.height = dims
                asteroid.speed = asteroidSpeed;
                app.stage.addChild(asteroid);

                return asteroid;
            }

            function updateLasers(delta) {
                for (let i = 0; i<lasers.length; i++) {
                    lasers[i].position.x += lasers[i].speed;
                    if (lasers[i].position.x > app.renderer.width){
                        lasers[i].dead = true;
                    }
                    //Handle Collision
                    for (let j = 0; j<asteroids.length; j++) {
                        if(rectsIntersect(lasers[i], asteroids[j])){
                            lasers[i].dead = true;
                            asteroids[j].dead = true;
                            score += 10;
                            scoreText.text = 'Score: ' + score;
                        }
                    }
                    
                }
                for (let i = 0; i<lasers.length; i++) {
                    if(lasers[i].dead == true) {
                        app.stage.removeChild(lasers[i]);
                        lasers.splice(i, 1);
                    }
                }
            }

            function updateAsteroids(delta) {
                for (let i = 0; i<asteroids.length; i++) {
                    asteroids[i].position.x -= asteroids[i].speed;
                    if (asteroids[i].position.x < 0){
                        asteroids[i].dead = true;
                    }
                    //Handle Collision
                    if(rectsIntersect(player, asteroids[i])){
                        //Game Over
                        gameOverText = new PIXI.Text('Game Over', gameOverStyle);
                        gameOverText.anchor.set(0.5);
                        gameOverText.x = app.view.width / 2;
                        gameOverText.y = app.view.height / 2;
                        app.stage.addChild(gameOverText)
                        app.ticker.stop();
                        score = 0;
                    }
                }
                for (let i = 0; i<asteroids.length; i++) {
                    if (asteroids[i].dead == true) {
                        app.stage.removeChild(asteroids[i]);
                        asteroids.splice(i, 1);
                    }
                }
            }
            
            function showProgress(e) {
                //console.log(e.progress);
            }

            function doneLoading(e) {
                //console.log("Done Loading.");
                //Player Object Creation:
                player = PIXI.Sprite.from(app.loader.resources.player.texture);
                player.anchor.set(0.5);
                player.x = app.view.width / 2;
                player.y = app.view.height / 2;
                player.width = 80;
                player.height = 80;
                player.speed = 3;
                app.stage.addChild(player);

                wasd = PIXI.Sprite.from(app.loader.resources.wasd.texture);
                wasd.anchor.set(0.5);
                wasd.x = app.view.width / 2;
                wasd.y = (app.view.height / 2) - 100;
                wasd.width = 177.5;
                wasd.height = 112;
                app.stage.addChild(wasd);
                
                //Game Over
                startText = new PIXI.Text('Press [SPACE] To Start', startGameStyle);
                startText.anchor.set(0.5);
                startText.x = app.view.width / 2;
                startText.y = (app.view.height / 2) - 210;
                app.stage.addChild(startText)
                startTime = Date.now();

            }

            function reportError(e) {
                console.error("Error: ", e.message);
            }

            function getRndInteger(min, max) {
                return Math.floor(Math.random() * (max - min) ) + min;
            }

            function getRndFloat(min, max) {
                return ((Math.random() * (max - min) ) + min).toFixed(2);
            }


            // function movePlayer(e){
            //     let pos = e.data.global;
            //     player.x = pos.x;
            //     player.y = pos.y;
            // }

        </script>
    </head>

    <body class="bodyHome" id="body-home">
        <div id="gameDiv">
        </div>
        <div class="TitleScreen">
            <img class="titeUFO" src = "gameImages/ufo_Large.png" />
            <h1 class="gameTitle">Space-Guy</h1>
                <h2 class="gameOptionsText" onclick="newGame()">New Game</h2>
                <h2 class="gameOptionsText">Scoreboard</h2>
            </div>
        </div>
    </body>
</html>